var $jscomp=$jscomp||{};$jscomp.scope={};$jscomp.findInternal=function(a,c,b){a instanceof String&&(a=String(a));for(var d=a.length,f=0;f<d;f++){var e=a[f];if(c.call(b,e,f,a))return{i:f,v:e}}return{i:-1,v:void 0}};$jscomp.ASSUME_ES5=!1;$jscomp.ASSUME_NO_NATIVE_MAP=!1;$jscomp.ASSUME_NO_NATIVE_SET=!1;$jscomp.defineProperty=$jscomp.ASSUME_ES5||"function"==typeof Object.defineProperties?Object.defineProperty:function(a,c,b){a!=Array.prototype&&a!=Object.prototype&&(a[c]=b.value)};
$jscomp.getGlobal=function(a){return"undefined"!=typeof window&&window===a?a:"undefined"!=typeof global&&null!=global?global:a};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(a,c,b,d){if(c){b=$jscomp.global;a=a.split(".");for(d=0;d<a.length-1;d++){var f=a[d];f in b||(b[f]={});b=b[f]}a=a[a.length-1];d=b[a];c=c(d);c!=d&&null!=c&&$jscomp.defineProperty(b,a,{configurable:!0,writable:!0,value:c})}};
$jscomp.polyfill("Array.prototype.find",function(a){return a?a:function(a,b){return $jscomp.findInternal(this,a,b).v}},"es6","es3");var newQueryEditor,sql_autocomplete_in_progress=!1,sql_autocomplete=!1,databaseName=$("#databaseName").val(),databaseConfigId=$("#databaseConfigId").val(),exportLimit=$("#exportLimit").val(),isRead=$("#isRead").val(),newQueryIndex=0,executeAjaxNew,databaseType=$("#databaseType").val();
$(document).ready(function(){newQueryEditor=CodeMirror.fromTextArea(document.getElementById("newQuerySqlArea"),{lineNumbers:!0,matchBrackets:!0,hintOptions:{completeSingle:!1,completeOnSingleClick:!0},indentUnit:4,mode:"text/x-mysql",lineWrapping:!0,theme:"eclipse",autofocus:!0,extraKeys:{ctrl:"autocomplete",F7:function(){newClearSQL()},F8:function(){newRun()}}});newQueryEditor.on("inputRead",codemirrorAutocompleteOnInputRead);newQueryEditor.refresh();$(newQueryEditor.getWrapperElement()).bind("keydown",
catchKeypressesFromSqlTextboxes);newQueryEditor.focus();var a=$.cookie("editStyleNew");a?(newQueryEditor.setOption("theme",a),newQueryExecuteMessage.setOption("theme",a),$("#codeThemeSelectorNew").val(a)):newQueryEditor.setOption("theme","eclipse")});
function codemirrorAutocompleteOnInputRead(a){sql_autocomplete_in_progress||a.options.hintOptions.tables&&sql_autocomplete||(sql_autocomplete?(a.options.hintOptions.tables=sql_autocomplete,a.options.hintOptions.defaultTable=sql_autocomplete_default_table):(a.options.hintOptions.defaultTable="",sql_autocomplete_in_progress=!0,$.ajax({type:"GET",url:baseUrl+"/system/permission/i/allTableAndColumn/"+databaseName+"/"+databaseConfigId,success:function(b){sql_autocomplete=[];a.options.hintOptions.tables=
b},complete:function(){sql_autocomplete_in_progress=!1}})));if(!a.state.completionActive){var c=a.getCursor();c=a.getTokenAt(c);var b="";c.string.match(/^[.`\w@]\w*$/)&&(b=c.string);0<b.length&&CodeMirror.commands.autocomplete(a)}}function catchKeypressesFromSqlTextboxes(a){!a.ctrlKey||13!=a.keyCode&&10!=a.keyCode||0<$("#newQuerySqlArea").length||0<$("#newQuerySqlArea").length&&newRun()}
var newQueryExecuteMessage=CodeMirror.fromTextArea(document.getElementById("newQueryExecuteMessage"),{mode:"text/x-mysql",theme:"eclipse",lineNumbers:!0,autofocus:!1,readOnly:!0});function selectThemeNew(){var a=$("#codeThemeSelectorNew").val();newQueryEditor.setOption("theme",a);newQueryExecuteMessage.setOption("theme",a);$.cookie("editStyleNew",a)}function newFormatSQL(){var a=$.trim(newQueryEditor.getValue());newQueryEditor.setValue(sqlFormatter.format(a))}
function newClearSQL(){$("#newQuerySqlArea").val("");$("#newQueryExecuteMessage").val("");newQueryEditor.setValue("");newQueryExecuteMessage.setValue("")}var newQueryDangerSQL=CodeMirror.fromTextArea(document.getElementById("newQueryDangerSQL"),{mode:"text/x-mysql",theme:"eclipse",lineNumbers:!0,lineWrapping:!0,readOnly:!0});newQueryDangerSQL.setSize("480px","250px");
function newRun(){var a=$.trim(newQueryEditor.getValue()),c=newQueryEditor.getSelection();""!=c&&(a=c);sqlArray=[];var b=[];messTemp="";""==a||null==a?($.messager.show({title:"\u63d0\u793a",msg:"\u8bf7\u8f93\u5165SQL\u8bed\u53e5\uff01"}),$.easyui.loaded()):""==databaseName||null==databaseName?$.messager.show({title:"\u63d0\u793a",msg:"\u8bf7\u70b9\u51fb\u5de6\u4fa7\u6307\u5b9a\u6570\u636e\u5e93\uff01"}):(disableOperButton(),$.ajax({type:"post",timeout:2E4,url:baseUrl+"/system/sqlParser/operationSQL",
data:{sql:a,databaseConfigId:databaseConfigId},success:function(a){if("success"==a.status){var c=a.rows;for(a=0;a<c.length;a++){var d=c[a].sqlType,g=c[a].sql;sqlArray.push(g);"select"!=d&&"create"!=d&&"insert"!=d&&b.push(g+"\n")}if(1==isRead&&0<b.length)$.messager.show({title:"\u63d0\u793a",msg:"\u5f53\u524d\u6570\u636e\u5e93\u53ea\u8bfb\uff0c\u4ec5\u5141\u8bb8\u67e5\u8be2.",position:"top",icon:"warning"}),enableOperButton();else if(a=$.cookie("noCaution"),0<b.length&&!a){$("#executeSqlConfirmDialog").dialog("open");
c="";for(a=0;a<b.length;a++)c+=b[a];newQueryDangerSQL.setValue(c)}else $.easyui.loading({msg:"\u6267\u884c\u4e2d...",locale:"#newQuerySqlAreaDiv"}),a=$("#newQuerySearchTabs").tabs("tabs"),1<a.length&&$.each(a,function(a,b){$("#newQuerySearchTabs").tabs("close",1)}),executeSQLArray(sqlArray,newQueryIndex)}else newQueryExecuteMessage.setValue(a.mess),$.messager.show({title:"\u63d0\u793a",msg:a.mess,position:"bottomRight",icon:"warning",timeout:2E3}),enableOperButton()}}))}
var executeSQLArray=function(a,c){if(c>=a.length){enableOperButton();$.messager.show({title:"\u63d0\u793a",msg:"\u6267\u884c\u5b8c\u6210\uff01",position:"bottomRight",timeout:2E3});$("#newQuerySearchTabs").tabs("select",0);newQueryExecuteMessage.setValue(messTemp);var b=$("#newQuerySearchTabs").tabs("tabs").length;$("#newQuerySearchTabs").tabs("select",b-1);$.easyui.loaded("#newQuerySqlAreaDiv")}else{var d=a[c];";"==d.substr(d.length-1,d.length)&&(d=d.substr(0,d.length-1));executeAjaxNew=$.ajax({type:"post",
timeout:2E4,url:baseUrl+"/system/permission/i/executeSqlText/"+databaseConfigId,data:{sql:d,databaseName:databaseName},success:function(b){var e=b.status;if(null==b.status)messTemp=messTemp+b+" \n\n";else{if("fail"==e){$.messager.show({title:"\u63d0\u793a",msg:"\u6267\u884c\u5931\u8d25\uff01",position:"bottomRight",timeout:2E3,icon:"warning"});messTemp=messTemp+"\u3010SQL\u3011\n"+d+"\n \u4fe1\u606f\uff1a"+b.mess+" \n\n";$("#newQuerySearchTabs").tabs("select",0);newQueryExecuteMessage.setValue(messTemp);
b=$("#newQuerySearchTabs").tabs("tabs").length;$("#newQuerySearchTabs").tabs("select",b-1);$.easyui.loaded("#newQuerySqlAreaDiv");enableOperButton();return}"success"==e?(messTemp=messTemp+"\u3010SQL\u3011\n"+d+"\n \u5f71\u54cd "+b.totalCount+" \u884c\uff0c \n \u6267\u884c\u65f6\u95f4\uff1a"+b.time+"\u6beb\u79d2\u3002\n\n",null!=b.rows&&showResultTabGrid(b,d,c)):messTemp=messTemp+"\u3010SQL\u3011\n"+d+"\n \u4fe1\u606f\uff1a"+b.mess+" \n\n"}executeSQLArray(a,c+1)},error:function(a,b,c){enableOperButton();
$.easyui.loaded("#newQuerySqlAreaDiv");$.messager.show({title:"\u63d0\u793a",msg:"\u6267\u884c\u5931\u8d25\uff01",position:"bottomRight",timeout:2E3,icon:"warning"})}})}},obj,willChangeRow=[];
function showResultTabGrid(a,c,b){var d="selectDg"+b,f=' <div id="tb'+b+'" style="padding:5px;height:auto"> <div>  <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-table-row-insert" plain="true" id="addRowButton'+b+'"  onclick="addRow2('+b+')"> \u6dfb\u52a0 </a>  <span class="toolbar-item dialog-tool-separator"></span>  <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-table-row-delete" plain="true" id="delButton'+b+'"   onclick="del( '+b+')">\u5220\u9664</a>  <span class="toolbar-item dialog-tool-separator"></span>  <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-table-edit" plain="true" id="editRowButton'+
b+'" onclick="editRow2('+b+' )">\u4fee\u6539</a>  <span class="toolbar-item dialog-tool-separator"></span>  <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-standard-page-excel" plain="true" title="\u5168\u90e8\u5bfc\u51faexcel"  id="editRowButton'+b+'" onclick="exportDataToExcelFromSQL('+b+' )">\u5bfc\u51fa</a>  <span class="toolbar-item dialog-tool-separator"></span>  <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-table-add"  plain="true" title="\u9009\u62e9\u590d\u5236\u4e3aInsert\u8bed\u53e5"  id="exportInsertSQLButton'+
b+'"  onclick="chooseSelectDataToSql('+b+',\'insert\' )">\u590d\u5236Insert</a>  <span class="toolbar-item dialog-tool-separator"></span>  <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-table-edit" plain="true" title="\u9009\u62e9\u590d\u5236\u4e3aUpdate\u8bed\u53e5"  id="exportUpdateSQLButton'+b+'" onclick="chooseSelectDataToSql('+b+',\'update\' )">\u590d\u5236Update</a>  <span class="toolbar-item dialog-tool-separator"></span>  <a href="javascript:void(0)" class="easyui-linkbutton"  plain="true"  >&nbsp;</a>  <span class="toolbar-item dialog-tool-separator"></span>  <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-ok" plain="true" id="saveRowButton'+
b+'"  onclick="saveRowNew('+b+' )"> \u4fdd\u5b58 </a>  <span class="toolbar-item dialog-tool-separator"></span>  <a href="javascript:void(0)" class="easyui-linkbutton" iconCls="icon-cancel" plain="true" id="cancelButton'+b+'"  onclick="cancelChange('+b+')"> \u53d6\u6d88 </a>  <span class="toolbar-item dialog-tool-separator"></span>  </div>  </div> ';$("#newQuerySearchTabs").tabs("add",{title:"\u7ed3\u679c"+(b+1),content:f+" <table id="+d+"></table>",closable:!0,tools:[{iconCls:"icon-berlin-calendar",
handler:function(){}}]});c={url:baseUrl+"/system/permission/i/executeSqlText/"+databaseConfigId,method:"POST",queryParams:{sql:c,databaseName:databaseName},rownumbers:!0,fit:!0,fitColumns:!0,border:!1,striped:!0,pagination:!0,pageNumber:1,pageSize:30,pageList:[20,30,40,50,100,200],singleSelect:!1,checkOnSelect:!0,toolbar:"#tb"+b,extEditing:!1,autoEditing:!0,singleEditing:!0,selectOnCheck:!0,onBeginEdit:function(a,b){obj=JSON.stringify(b)},onBeforeLoad:function(a){a=$(this).attr("firstLoad");return"false"==
a||"undefined"==typeof a?($(this).attr("firstLoad","true"),!1):!0},onAfterEdit:function(a,b,c){willChangeRow.push({oldData:eval("("+obj+")"),changesData:c})},onDblClickCell:function(a,b,c){c=$(this).datagrid("getColumnFields",!0).concat($(this).datagrid("getColumnFields"));for(var d=0;d<c.length;d++){var e=$(this).datagrid("getColumnOption",c[d]);e.editor1=e.editor;c[d]!=b&&(e.editor=null)}$(this).datagrid("beginEdit",a);for(d=0;d<c.length;d++)e=$(this).datagrid("getColumnOption",c[d]),e.editor=e.editor1},
onLoadSuccess:function(a){if(0==a.total){a=$(this).data().datagrid.dc.body2;var b=a.width();a.find("table tbody").append("<tr><td width = '"+b+"' style=' height: 25px; text-align: center;' colspan='6'>\u6682\u65e0\u6570\u636e\uff01</td></tr>")}}};c.columns=eval(a.columns);c.idField=a.primaryKey;c.tableName=a.tableName;d=$("#"+d);0<b&&(c.onDblClickCell=null);d.datagrid(c);d.datagrid("loadData",a.rows);d.datagrid("getPager").pagination("refresh",{total:a.total});c=d.datagrid("getPager").pagination("options").displayMsg;
d.datagrid("getPager").pagination("refresh",{displayMsg:'<span class="pagination-btn-separator "></span> &nbsp; <span class="icon-hamburg-full-time">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span> &nbsp;\u6267\u884c\u65f6\u95f4\uff1a'+a.time+"\u6beb\u79d2 &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; "+c});if(null==a.operator||"read"==a.operator)$("#addRowButton"+b).linkbutton("disable"),$("#copyRowButton"+b).linkbutton("disable"),$("#delButton"+b).linkbutton("disable"),$("#editRowButton"+b).linkbutton("disable"),
$("#saveRowButton"+b).linkbutton("disable"),$("#cancelButton"+b).linkbutton("disable");0<b&&($("#addRowButton"+b).linkbutton("disable"),$("#copyRowButton"+b).linkbutton("disable"),$("#delButton"+b).linkbutton("disable"),$("#editRowButton"+b).linkbutton("disable"),$("#saveRowButton"+b).linkbutton("disable"),$("#cancelButton"+b).linkbutton("disable"));if(null==databaseType||"MongoDB"==databaseType)$("#exportInsertSQLButton"+b).linkbutton("disable"),$("#exportUpdateSQLButton"+b).linkbutton("disable")}
function exportDataToExcelFromSQL(a){var c=$("#selectDg"+a).datagrid("options").queryParams.sql;$("#selectDg"+a).datagrid("options");$("#sql").val(c);$("#exportType").val("excel");a=$("#selectDg"+a).datagrid("getData").total;0<exportLimit&&exportLimit<a?$.messager.show({title:"\u63d0\u793a",msg:"\u5bfc\u51fa\u6570\u636e\u8d85\u51fa\u4e0a\u9650\uff01",position:"bottomRight"}):$("#newQueryform3").submit()}
function executeSQLOperator(){$("#executeSqlConfirmDialog").dialog("close");$.easyui.loading({msg:"\u6267\u884c\u4e2d...",locale:"#newQuerySqlAreaDiv"});var a=$("#newQuerySearchTabs").tabs("tabs");1<a.length&&$.each(a,function(a,b){$("#newQuerySearchTabs").tabs("close",1)});executeSQLArray(sqlArray,newQueryIndex)}
function newSaveSearch(){saveSearch=$("#newDlgg").dialog({title:"SQL\u4fdd\u5b58",width:380,height:160,href:baseUrl+"/searchHistory/form",maximizable:!0,modal:!0,buttons:[{text:"\u4fdd\u5b58",iconCls:"icon-ok",handler:function(){newSaveSearchHistory()}},{text:"\u53d6\u6d88",iconCls:"icon-cancel",handler:function(){saveSearch.panel("close")}}]})}function newStopRun(){enableOperButton();executeAjaxNew.abort();$.easyui.loaded("#newQuerySqlAreaDiv")}
function disableOperButton(){$("#newRunButton").linkbutton("disable");$("#newStopRunButton").linkbutton("enable");$("#newClearSQLButton").linkbutton("disable");$("#newFormatSQLButton").linkbutton("disable");$("#newSaveSearchButton").linkbutton("disable");$("#codeThemeSelectorNew").attr("disabled",!0)}
function enableOperButton(){$("#newRunButton").linkbutton("enable");$("#newStopRunButton").linkbutton("disable");$("#newClearSQLButton").linkbutton("enable");$("#newFormatSQLButton").linkbutton("enable");$("#newSaveSearchButton").linkbutton("enable");$("#codeThemeSelectorNew").attr("disabled",!1)}
function chooseSelectDataToSql(a,c){var b=$("#selectDg"+a).datagrid("getSelections");if(0==b.length)$.messager.show({title:"\u63d0\u793a",msg:"\u8bf7\u9009\u62e9\u6570\u636e\u884c\uff01",position:"bottomRight"});else{var d="",f=$("#selectDg"+a).datagrid("getColumns");$("#selectDg"+a).datagrid("options");var e=$("#selectDg"+a).datagrid("options").tableName,g=$("#selectDg"+a).datagrid("options").idField;if(null==e||""==e)e=" TABLE_NAME ";if("insert"==c){var h="";d="insert into "+e;$.each(b,function(a,
b){var c="",e="";$.each(f,function(a,d){a=b[d.field];var f=d.field+",";null!=a&&0<(a+"").indexOf("'")&&(a=a.replace("'","\\'"));if(null==a)a="NULL,";else if(""===a)a="'',";else{if("(BLOB)"==a||"(CLOB)"==a)return!0;a="numberbox"==d.editor?a+",":"datetimebox"==d.editor&&"Oracle"==databaseType?"to_date('"+a+"','yyyy-mm-dd hh24:mi:ss'),":"'"+a+"',"}e+=f;c+=a});e=e.substring(0,e.length-1);c=c.substring(0,c.length-1);h=h+d+" ( "+e+" ) values ("+c+");\r\n"});newQueryEditor.setValue(h+newQueryEditor.getValue()+
"\n");$.messager.show({title:"\u63d0\u793a",msg:"\u6210\u529f\u590d\u5236"+b.length+"\u884c",position:"bottomRight"})}if("update"==c){h="";var k=[];g&&(k=g.split(","));$.each(b,function(a,b){var c="update "+e+" set ";$.each(f,function(a,d){if(!$.inArray(d.field,k))return!0;a=b[d.field];null!=a&&0<(a+"").indexOf("'")&&(a=a.replace("'","\\'"));if(null==a)a="NULL,";else if(""===a)a="'',";else{if("(BLOB)"==a||"(CLOB)"==a)return!0;a="numberbox"==d.editor?a+",":"datetimebox"==d.editor&&"Oracle"==databaseType?
"to_date('"+a+"','yyyy-mm-dd hh24:mi:ss'),":"'"+a+"',"}c=c+d.field+"="+a});c=c.substring(0,c.length-1);var d="";g?(d=" where 1=1 ",$.each(k,function(a,c){d=b[c]?d+" and "+c+"='"+b[c]+"' ":d+" and "+c+"='' "})):d=" where 1=2 ";h=h+c+d+";\r\n"});newQueryEditor.setValue(h+newQueryEditor.getValue()+"\n");$.messager.show({title:"\u63d0\u793a",msg:"\u6210\u529f\u590d\u5236"+b.length+"\u884c",position:"bottomRight"})}}}
function addRow2(a){$("#selectDg"+a).datagrid("getChanges","updated").length?$.messager.show({title:"\u63d0\u793a",msg:"\u8bf7\u5148\u4fdd\u5b58\u53d8\u66f4\u5185\u5bb9\uff01",position:"bottomRight"}):($("#selectDg"+a).datagrid("insertRow",{index:0,row:{}}),$("#selectDg"+a).datagrid("beginEdit",0))}
function del(a){endEdit(a);var c=$("#selectDg"+a).datagrid("options"),b=c.idField,d=c.tableName;c=$("#selectDg"+a).datagrid("getChanges","inserted");var f=$("#selectDg"+a).datagrid("getChanges","updated");if(c.length||f.length)$.messager.show({title:"\u63d0\u793a",msg:"\u8bf7\u5148\u4fdd\u5b58\u53d8\u66f4\u5185\u5bb9\uff01",position:"bottomRight"});else{var e=$("#selectDg"+a).datagrid("getChecked");c=e.length;0==e.length?$.messager.show({title:"\u63d0\u793a",msg:"\u8bf7\u5148\u9009\u62e9\u4e00\u884c\u6570\u636e\uff01",
position:"bottomRight"}):$.easyui.messager.confirm("\u64cd\u4f5c\u63d0\u9192","\u60a8\u786e\u5b9a\u8981\u5220\u9664"+c+"\u884c\u6570\u636e\uff1f",function(c){c&&$.ajax({type:"POST",contentType:"application/json;charset=utf-8",url:baseUrl+"/system/permission/i/deleteRows/"+databaseConfigId,data:JSON.stringify({databaseName:databaseName,tableName:d,primary_key:b,checkedItems:JSON.stringify(e)}),datatype:"json",success:function(b){"success"==b.status?($("#selectDg"+a).datagrid("reload"),$("#selectDg"+
a).datagrid("clearSelections").datagrid("clearChecked"),selectRowCount=0,$.messager.show({title:"\u63d0\u793a",msg:"\u5220\u9664\u6210\u529f\uff01",position:"bottomRight"})):$.messager.show({title:"\u63d0\u793a",msg:b.mess,position:"bottomRight",timeout:2E3,icon:"warning"})}})})}}
function editRow2(a){var c=$("#selectDg"+a).datagrid("getChecked");0==c.length?$.messager.show({title:"\u63d0\u793a",msg:"\u8bf7\u5148\u9009\u62e9\u4e00\u884c\u6570\u636e\uff01",position:"bottomRight"}):$.each(c,function(b,c){b=$("#selectDg"+a).datagrid("getRowIndex",c);$("#selectDg"+a).datagrid("beginEdit",b)})}function cancelChange(a){endEdit(a);refresh(a)}function refresh(a){$("#selectDg"+a).datagrid("reload");$("#selectDg"+a).datagrid("clearSelections").datagrid("clearChecked")}
function saveRowNew(a){endEdit(a);var c=$("#selectDg"+a).datagrid("getChanges","inserted"),b=willChangeRow,d={},f=$("#selectDg"+a).datagrid("options"),e=f.idField,g=f.tableName;d.databaseName=f.queryParams.databaseName;d.tableName=g;d.primary_key=e;c.length&&(d.inserted=JSON.stringify(c));b.length&&(d.updated=JSON.stringify(b));(c.length||b.length)&&$.post(baseUrl+"/system/permission/i/saveData/"+databaseConfigId,d,function(b){willChangeRow=[];"success"==b.status?($.messager.show({title:"\u63d0\u793a",
msg:"\u4fdd\u5b58\u6210\u529f\uff01",position:"bottomRight"}),$("#selectDg"+a).datagrid("acceptChanges")):$.messager.alert("\u63d0\u793a",b.mess)},"JSON").error(function(){$.messager.alert("\u63d0\u793a","\u63d0\u4ea4\u9519\u8bef\u4e86\uff01")})}function endEdit(a){for(var c=$("#selectDg"+a).datagrid("getRows"),b=0;b<c.length;b++)$("#selectDg"+a).datagrid("endEdit",b)};
